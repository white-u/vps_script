# Cloudflare Worker 中控部署指南

本文档介绍如何部署 **vps_script** 的云端中控台。
部署后，你可以通过 Telegram Bot 集中查询多台 VPS 的流量使用情况，并支持为合租用户分配查询权限。

---

## 1. 原理架构

```mermaid
graph LR
    A[VPS 1 (HK)] -->|每分钟推送| C(Cloudflare Worker)
    B[VPS 2 (US)] -->|每分钟推送| C
    C <-->|读写数据| D[(D1 Database)]
    E[Telegram Bot] <-->|查询指令| C
```

*   **VPS 端:** 使用 `pm.sh` 的推送功能，每分钟加密推送流量数据。
*   **服务端:** Cloudflare Worker (免费版每天 10万次请求，足够几十台 VPS 使用)。
*   **数据库:** Cloudflare D1 (Serverless SQL 数据库)。

---

## 2. 准备工作

1.  **Cloudflare 账号:** 注册并登录。
2.  **Telegram Bot:**
    *   找 @BotFather 申请一个 Bot，获取 **Token**。
    *   获取你自己的 Telegram ID (User ID)，也就是管理员 ID。

---

## 3. 部署步骤 (网页版操作)

### 3.1 创建 D1 数据库

1.  登录 Cloudflare Dashboard，进入 **Workers & Pages** -> **D1**。
2.  点击 **Create database**。
3.  命名为 `vps_db` (或者你喜欢的名字)，点击 **Create**。
4.  进入数据库详情页，点击 **Console** 标签页。
5.  **执行初始化 SQL:** (将以下代码粘贴到控制台并 Execute)

```sql
-- 存储节点数据
CREATE TABLE IF NOT EXISTS nodes (
    node_key TEXT PRIMARY KEY,
    node_id TEXT,
    config_json TEXT,
    updated_at INTEGER
);

-- 存储用户权限
CREATE TABLE IF NOT EXISTS users (
    user_id TEXT,
    node_key TEXT,
    ports TEXT,
    comment TEXT,
    PRIMARY KEY (user_id, node_key)
);
```

### 3.2 创建 Worker

1.  回到 **Workers & Pages** -> **Overview**。
2.  点击 **Create application** -> **Create Worker**。
3.  命名为 `vps-monitor`，点击 **Deploy**。
4.  点击 **Edit code**。
5.  将仓库中的 `worker.js` 内容完整复制粘贴到编辑器中（覆盖原有代码）。
6.  点击右上角 **Deploy**。

### 3.3 绑定数据库与环境变量

1.  回到 Worker 的 **Settings** 页面。
2.  **绑定 D1 数据库:**
    *   进入 **Bindings** -> **Add** -> **D1 Database**。
    *   **Variable name:** 输入 `DB` (必须是大写 DB，与代码对应)。
    *   **Database:** 选择刚才创建的 `vps_db`。
    *   点击 **Deploy** 保存。
3.  **设置环境变量:**
    *   进入 **Variables** -> **Add Variable**。
    *   添加以下变量 (点击 Encrypt 加密敏感信息):
        *   `BOT_TOKEN`: 你的 Telegram Bot Token。
        *   `ADMIN_ID`: 你的 Telegram User ID (纯数字)。
        *   `SHARED_SECRET`: 自定义一个复杂的通信密钥 (用于 VPS 签名，例如 `MySuperSecretKey123`)。
    *   点击 **Deploy** 保存。

### 3.4 配置 Telegram Webhook

你需要告诉 Telegram 把消息转发给你的 Worker。
在浏览器访问以下 URL (替换 `{TOKEN}` 和 `{WORKER_URL}`):

```
https://api.telegram.org/bot{TOKEN}/setWebhook?url=https://{WORKER_URL}/webhook
```

*   `{TOKEN}`: 你的 Bot Token。
*   `{WORKER_URL}`: 你的 Worker 域名 (例如 `vps-monitor.你的名.workers.dev`)。

如果返回 `{"ok":true, ...}` 说明配置成功。

---

## 4. VPS 端配置

登录你的 VPS，运行 `pm` 进入菜单，选择 **5. 云端推送 (Cloudflare)**。

1.  **Worker URL:** 填入 `https://vps-monitor.你的名.workers.dev/api/push` (注意末尾加上 `/api/push`)。
2.  **密钥:** 填入刚才设置的 `SHARED_SECRET`。
3.  **节点 Key:** 给这台 VPS 起个唯一的英文代号 (例如 `hk-01`, `us-aws`)。
4.  **开启推送:** 选择开启。

等待 1-2 分钟，VPS 会自动进行第一次推送。

---

## 5. 使用 Telegram Bot

### 管理员指令

*   `/ll` : 查看所有节点在线状态。
*   `/ll all` : 查看所有节点的详细流量报表。
*   `/ll hk-01` : 查看指定节点的流量。
*   `/users` : 查看所有已授权的用户。
*   `/delnode hk-01` : 删除某个节点的数据。

### 用户授权 (合租管理)

如果你想让用户 A (ID: `123456`) 查看 `hk-01` 节点上的 `8080` 和 `443` 端口：

```text
/add 123456 hk-01 8080,443 备注信息
```

授权后，用户 A 发送 `/ll` 就只能看到这两个端口的流量，看不到其他数据。

---

## 6. 故障排查

*   **Worker 返回 "Bad Request":** VPS 推送格式错误，检查 `pm.sh` 版本是否为 v4.4+。
*   **Worker 返回 "Forbidden":** 密钥 (`SHARED_SECRET`) 不匹配。
*   **Worker 返回 "Timestamp expired":** VPS 时间与标准时间相差超过 2 分钟，请同步 VPS 时间 (`ntpdate pool.ntp.org`)。
*   **Bot 不回复:** 检查 Webhook 是否设置成功，或者 `BOT_TOKEN` 环境变量是否正确。
