# PM 云端流量查询系统 — 部署教程

## 一、方案总结

### 解决了什么问题

pm.sh 原本只能 SSH 登录 VPS 查看流量，或者等 Telegram 定时推送报告。现在通过 Telegram Bot 随时输入 `/ll` 即可远程查询任意节点的实时流量数据，并且支持多用户权限隔离。

### 架构

```
┌──────────────────────────────────────────────────────┐
│  VPS (可部署多台)                                      │
│                                                       │
│  pm.sh (v4.4)                                        │
│    ├── 原有功能: 端口监控 / 限速 / 封禁 / Telegram通知  │
│    └── 新增功能: 每分钟自动推送端口数据 (出站HTTPS)      │
│                          │                            │
│          零入站端口       │  HMAC-SHA256 签名           │
└──────────────────────────┼────────────────────────────┘
                           ▼
               ┌───────────────────────┐
               │   Cloudflare Worker   │
               │                       │
               │   /api/push ← VPS推送  │
               │   /webhook  ← Telegram │
               │       ↕                │
               │   D1 数据库 (SQLite)    │
               │   每节点仅保留1行数据    │
               └───────────────────────┘
                           ▲
                           │ Webhook
                           ▼
               ┌───────────────────────┐
               │   Telegram Bot        │
               │                       │
               │   /ll     → 查看节点   │
               │   /ll hk  → 查询指定   │
               │   /ll all → 查询全部   │
               │   /help   → 帮助      │
               └───────────────────────┘
```

### 安全设计

| 特性 | 说明 |
|------|------|
| VPS 零入站端口 | 只有出站 HTTPS，不开监听端口 |
| HMAC-SHA256 签名 | 每次推送携带时间戳签名，120秒过期防重放 |
| 数据脱敏 | 推送内容不含 bot_token、push secret 等敏感信息 |
| 权限隔离 | Worker 独立控制用户可见节点和端口，VPS 不参与权限判断 |

### 资源消耗 (以 3 个 VPS 节点为例)

| 资源 | 每日用量 | 免费额度 | 占比 |
|------|---------|---------|------|
| D1 写入 | 4,320 次 | 100,000 次 | 4.3% |
| D1 读取 | ~100 次 | 5,000,000 次 | 0.002% |
| Worker 请求 | ~4,500 次 | 100,000 次 | 4.5% |
| D1 存储 | < 1 MB | 5 GB | ≈ 0% |

---

## 二、涉及的文件

| 文件 | 用途 | 部署位置 |
|------|------|---------|
| `pm.sh` (v4.4) | VPS 端口监控脚本 (含推送功能) | 每台 VPS |
| `worker.js` | Cloudflare Worker 中控脚本 | Cloudflare Dashboard |
| `d1_schema.sql` | D1 数据库建表语句 | Cloudflare D1 Console |

---

## 三、部署步骤

### 第 1 步：创建 D1 数据库

1. 登录 [Cloudflare Dashboard](https://dash.cloudflare.com)
2. 左侧菜单 → **Workers & Pages** → **D1 SQL Database**
3. 点击 **Create** → 数据库名称填 `pm_data` → 点击 Create
4. 进入刚创建的数据库 → 点击 **Console** 标签
5. 粘贴以下 SQL 并执行：

```sql
CREATE TABLE IF NOT EXISTS nodes (
    node_key    TEXT PRIMARY KEY,
    node_id     TEXT DEFAULT '',
    config_json TEXT NOT NULL DEFAULT '{}',
    updated_at  INTEGER NOT NULL DEFAULT 0
);
```

看到 `Query executed successfully` 即可。

---

### 第 2 步：创建并部署 Worker

1. 左侧菜单 → **Workers & Pages** → **Create**
2. 选择 **Hello World** 模板 → 名称填 `bot`（或你想要的名称）→ **Deploy**
3. 部署后点击 **Edit Code** → 删除全部默认代码 → 粘贴 `worker.js` 全部内容 → **Deploy**

---

### 第 3 步：配置 Worker 环境变量

进入 Worker → **Settings** → **Variables and Secrets** → 添加以下 4 个变量：

| 名称 | 值 | 说明 |
|------|-----|------|
| `SHARED_SECRET` | （在 VPS 上执行 `openssl rand -hex 32` 生成） | VPS 推送签名密钥 |
| `BOT_TOKEN` | `8330228409:AAFTQ...` | 从 @BotFather 获取 |
| `ADMIN_ID` | `6794760514` | 管理员 Telegram ID (从 @userinfobot 获取) |
| `USERS_JSON` | `{}` | 普通用户权限表，暂时留空 |

> **SHARED_SECRET 生成方法**：在任意 VPS 上执行 `openssl rand -hex 32`，复制输出结果。这个密钥需要在 Worker 和每台 VPS 上各保存一份。

---

### 第 4 步：绑定 D1 数据库

仍在 Worker Settings 页面：

1. 找到 **Bindings** 部分 → **Add**
2. 类型选 **D1 Database**
3. **Variable name** 填 `DB`（必须大写）
4. 选择之前创建的 `pm_data` 数据库
5. **Save**

---

### 第 5 步：绑定 Telegram Webhook

在浏览器地址栏访问以下 URL（替换你的 BOT_TOKEN）：

```
https://api.telegram.org/bot你的完整BOT_TOKEN/setWebhook?url=https://bot.whiteu0120.workers.dev/webhook
```

看到以下返回即成功：

```json
{"ok":true,"result":true,"description":"Webhook was set"}
```

---

### 第 6 步：更新 VPS 上的 pm.sh

在每台 VPS 上执行：

```bash
# 方式 1: 直接下载新版本（如果你已更新 GitHub 上的脚本）
curl -fsSL https://raw.githubusercontent.com/white-u/vps_script/main/pm.sh -o /usr/local/bin/pm && chmod +x /usr/local/bin/pm

# 方式 2: 手动替换
# 将新的 pm.sh (v4.4) 文件上传到 VPS，覆盖 /usr/local/bin/pm
```

---

### 第 7 步：在 VPS 上配置推送

运行 `pm` 进入管理面板 → 选择 **5. 云端推送 (Cloudflare)** → 依次操作：

| 操作 | 填写内容 |
|------|---------|
| 1. 配置 Worker URL | `https://bot.whiteu0120.workers.dev/api/push` |
| 2. 配置通信密钥 | 第 3 步生成的 `SHARED_SECRET`（必须一致） |
| 3. 配置节点 Key | 节点标识，如 `hk`、`us`、`sg`（每台 VPS 不同） |
| 5. 测试推送 | 看到 `✅ 推送成功! (HTTP 200)` |
| 4. 开启推送 | 确认开启 |

> 每台 VPS 重复此步骤，节点 Key 使用不同标识。密钥和 Worker URL 保持一致。

---

## 四、验证

打开 Telegram，给你的 Bot 发送：

| 指令 | 预期结果 |
|------|---------|
| `/ll` | 显示所有节点列表及在线状态 |
| `/ll hk` | 显示 hk 节点的全部端口流量详情 |
| `/ll all` | 显示所有节点的全部端口流量详情 |
| `/help` | 显示帮助信息 |

---

## 五、添加普通用户

如果需要让其他 Telegram 用户查询指定端口的流量，修改 Worker 的 `USERS_JSON` 环境变量：

```json
{
  "987654321": [
    {"node": "hk", "ports": [8080, 8081]},
    {"node": "us", "ports": [443]}
  ],
  "111222333": [
    {"node": "sg", "ports": [8080]}
  ]
}
```

- Key 是用户的 Telegram ID（字符串格式）
- 每个用户可绑定多个节点，每个节点可指定多个允许查看的端口
- 普通用户发送 `/ll` 时只能看到被分配的节点和端口
- 未在列表中的陌生人发消息会被静默忽略

---

## 六、卸载

### 仅关闭推送（保留 pm.sh 其他功能）

运行 `pm` → 选择 **5. 云端推送** → 选择 **4. 开启/关闭推送** → 关闭

### 完整卸载 PM

运行 `pm` → 选择 **7. 卸载脚本**，或通过 `vt` 工具箱 → **8. 全部卸载**

推送功能没有独立进程和配置文件，随 PM 卸载自动清除。

### 清理云端

如果不再使用，可在 Cloudflare Dashboard 删除 Worker 和 D1 数据库。

---

## 七、故障排查

| 现象 | 原因 | 解决 |
|------|------|------|
| 测试推送返回 500 | Worker 环境变量或 D1 绑定缺失 | 检查 4 个环境变量 + DB 绑定 |
| 测试推送返回 403 | 密钥不一致或时间戳过期 | 确认 VPS 和 Worker 的密钥完全一致；检查 VPS 时钟 (`date`) |
| 测试推送返回 000 | 网络不通 | 检查 VPS 能否 `curl https://bot.whiteu0120.workers.dev` |
| Bot 不回复消息 | Webhook 未绑定 | 重新访问 setWebhook URL |
| Bot 回复"节点未找到" | 节点 Key 不匹配 | 确认 `/ll hk` 中的 `hk` 与 VPS 配置的 node_key 一致 |
| 节点显示 🔴 离线 | 推送中断超过 3 分钟 | 检查 VPS 的 cron 是否正常运行 (`crontab -l`) |
| 推送静默失败无提示 | openssl 未安装 | VPS 上执行 `apt install openssl` |
