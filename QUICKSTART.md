# ğŸš€ å¿«é€Ÿå…¥é—¨æŒ‡å—

## 5 åˆ†é’Ÿä¸Šæ‰‹ç«¯å£æµé‡ç›‘æ§ç³»ç»Ÿ v2.0

### æ­¥éª¤ 1: ä¸‹è½½è„šæœ¬

```bash
cd /tmp
wget https://raw.githubusercontent.com/white-u/vps_script/main/port-monitor-v2.sh
chmod +x port-monitor-v2.sh
```

### æ­¥éª¤ 2: æ£€æŸ¥ä¾èµ–

```bash
# Debian/Ubuntu
sudo apt update
sudo apt install nftables iproute2 jq sqlite3 bc systemd

# CentOS/RHEL
sudo yum install nftables iproute-tc jq sqlite bc systemd
```

### æ­¥éª¤ 3: å¯åŠ¨è„šæœ¬

```bash
sudo ./port-monitor-v2.sh
```

é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ï¼š
- åˆ›å»ºæ•°æ®åº“ `/etc/port-traffic-monitor/config.db`
- åˆå§‹åŒ– nftables è¡¨
- è®¾ç½® TC é˜Ÿåˆ—
- åˆ›å»ºå¿«æ·å‘½ä»¤ `ptm`

---

## ğŸ“‹ åŸºæœ¬æ“ä½œ

### æ·»åŠ ç›‘æ§ç«¯å£

```
ä¸»èœå• â†’ 1. æ·»åŠ ç«¯å£

ç«¯å£å·: 8000
å¤‡æ³¨: WebæœåŠ¡
è®¡è´¹æ¨¡å¼: single  (åªè®¡å‡ºç«™æµé‡)
```

### è®¾ç½®å¸¦å®½é™é€Ÿ

```
ä¸»èœå• â†’ 4. å¸¦å®½é™é€Ÿ

é€‰æ‹©ç«¯å£: 1
é€Ÿç‡: 10mbps  (10å…†æ¯”ç‰¹æ¯ç§’)
```

### è®¾ç½®æµé‡é…é¢

```
ä¸»èœå• â†’ 5. æµé‡é…é¢

é€‰æ‹©ç«¯å£: 1
é…é¢: 100GB
æ¯æœˆé‡ç½®æ—¥æœŸ: 1  (æ¯æœˆ1æ—¥é‡ç½®)
```

### é…ç½®çªå‘ä¿æŠ¤

```
ä¸»èœå• â†’ 7. çªå‘ä¿æŠ¤

é€‰æ‹©ç«¯å£: 1
â†’ 1. å¯ç”¨/é…ç½®çªå‘ä¿æŠ¤

è§¦å‘é€Ÿç‡: 50mbps       # è¶…è¿‡æ­¤é€Ÿç‡è§¦å‘ä¿æŠ¤
æ£€æµ‹çª—å£: 30           # æŒç»­30åˆ†é’Ÿ
é™é€Ÿè‡³: 5mbps          # é™é€Ÿåˆ°5mbps
é™é€Ÿæ—¶é•¿: 10           # æŒç»­10åˆ†é’Ÿåæ¢å¤
```

### é…ç½® Telegram é€šçŸ¥

1. **åˆ›å»º Bot**
   - ä¸ @BotFather å¯¹è¯
   - å‘é€ `/newbot`
   - è·å– Bot Tokenï¼ˆæ ¼å¼ï¼š`123456:ABC-DEF...`ï¼‰

2. **è·å– Chat ID**
   - ä¸ä½ çš„ Bot å‘é€æ¶ˆæ¯ï¼š"test"
   - è®¿é—®ï¼š`https://api.telegram.org/bot<YOUR_TOKEN>/getUpdates`
   - æ‰¾åˆ° `"chat":{"id":123456789}`

3. **é…ç½®è„šæœ¬**
   ```
   ä¸»èœå• â†’ 8. Telegram

   â†’ 2. è®¾ç½® Bot Token
   Bot Token: 123456:ABC-DEF...

   â†’ 3. è®¾ç½® Chat ID
   Chat ID: 123456789

   â†’ 1. å¯ç”¨/ç¦ç”¨é€šçŸ¥
   (åˆ‡æ¢ä¸ºå¯ç”¨)

   â†’ 4. æµ‹è¯•é€šçŸ¥
   (å‘é€æµ‹è¯•æ¶ˆæ¯)
   ```

---

## ğŸ’¡ ä½¿ç”¨æŠ€å·§

### æŸ¥çœ‹ç«¯å£æµé‡

ä¸»ç•Œé¢å®æ—¶æ˜¾ç¤ºï¼š
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘             ç«¯å£æµé‡ç›‘æ§ v2.0.0                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  8000     â†‘1.2GB    â†“3.5GB   è®¡:4.7GB    [45%] âš¡           â•‘
â•‘    [WebæœåŠ¡] é…é¢:10GB é™é€Ÿ:10mbps                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

è¯´æ˜ï¼š
- â†‘ = å…¥ç«™æµé‡ (ä¸‹è½½)
- â†“ = å‡ºç«™æµé‡ (ä¸Šä¼ )
- è®¡ = è®¡è´¹æµé‡ (æ ¹æ®è®¡è´¹æ¨¡å¼)
- [45%] = é…é¢ä½¿ç”¨ç™¾åˆ†æ¯”
- âš¡ = çªå‘ä¿æŠ¤å·²å¯ç”¨
- ğŸ”½5m = å½“å‰é™é€Ÿä¸­ï¼Œå‰©ä½™5åˆ†é’Ÿæ¢å¤
```

### å¿«æ·å‘½ä»¤

å®‰è£…åå¯ä»¥ä½¿ç”¨ï¼š
```bash
ptm              # æ‰“å¼€äº¤äº’å¼ç•Œé¢
ptm --help       # æ˜¾ç¤ºå¸®åŠ©
ptm --version    # æ˜¾ç¤ºç‰ˆæœ¬
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹å‘Šè­¦æ£€æŸ¥æ—¥å¿—
journalctl -u port-traffic-alert.service -f

# æŸ¥çœ‹çªå‘ä¿æŠ¤æ—¥å¿—
journalctl -u port-traffic-burst.service -f

# æŸ¥çœ‹ç«¯å£é‡ç½®æ—¥å¿—
journalctl -u port-traffic-reset-8000.service
```

### æŸ¥çœ‹å®šæ—¶å™¨çŠ¶æ€

```bash
# æŸ¥çœ‹æ‰€æœ‰å®šæ—¶å™¨
systemctl list-timers | grep port-traffic

# æŸ¥çœ‹ç‰¹å®šå®šæ—¶å™¨
systemctl status port-traffic-alert.timer
```

### æ‰‹åŠ¨è§¦å‘æ£€æŸ¥

```bash
# æ‰‹åŠ¨æ£€æŸ¥å‘Šè­¦
sudo ptm --check-alert

# æ‰‹åŠ¨æ£€æŸ¥çªå‘ä¿æŠ¤
sudo ptm --check-burst

# æ‰‹åŠ¨é‡ç½®ç«¯å£
sudo ptm --reset-port 8000
```

---

## ğŸ¯ å¸¸è§åœºæ™¯é…ç½®

### åœºæ™¯ 1: æ¸¸æˆæœåŠ¡å™¨

```
ç«¯å£: 25565
å¤‡æ³¨: Minecraft
è®¡è´¹: single (åªè®¡å‡ºç«™)
é™é€Ÿ: 50mbps
é…é¢: 200GB/æœˆ
çªå‘ä¿æŠ¤: å…³é—­ (æ¸¸æˆéœ€è¦ç¨³å®šè¿æ¥)
```

### åœºæ™¯ 2: Web æœåŠ¡å™¨

```
ç«¯å£: 80,443
å¤‡æ³¨: Nginx
è®¡è´¹: single
é™é€Ÿ: 100mbps
é…é¢: 500GB/æœˆ
çªå‘ä¿æŠ¤:
  - è§¦å‘é€Ÿç‡: 80mbps
  - æ£€æµ‹çª—å£: 20åˆ†é’Ÿ
  - é™é€Ÿè‡³: 20mbps
  - é™é€Ÿæ—¶é•¿: 30åˆ†é’Ÿ
```

### åœºæ™¯ 3: ä»£ç†æœåŠ¡å™¨

```
ç«¯å£: 10000-10100 (ç«¯å£èŒƒå›´)
å¤‡æ³¨: ä»£ç†æ± 
è®¡è´¹: double (åŒå‘è®¡è´¹)
é™é€Ÿ: 200mbps
é…é¢: 1TB/æœˆ
çªå‘ä¿æŠ¤:
  - è§¦å‘é€Ÿç‡: 150mbps
  - æ£€æµ‹çª—å£: 30åˆ†é’Ÿ
  - é™é€Ÿè‡³: 50mbps
  - é™é€Ÿæ—¶é•¿: 60åˆ†é’Ÿ
```

### åœºæ™¯ 4: ä¸‹è½½ç«™

```
ç«¯å£: 8080
å¤‡æ³¨: æ–‡ä»¶ä¸‹è½½
è®¡è´¹: single
é™é€Ÿ: æ— é™é€Ÿ (ä¸è®¾ç½®)
é…é¢: 10TB/æœˆ
çªå‘ä¿æŠ¤:
  - è§¦å‘é€Ÿç‡: 500mbps
  - æ£€æµ‹çª—å£: 60åˆ†é’Ÿ
  - é™é€Ÿè‡³: 100mbps
  - é™é€Ÿæ—¶é•¿: 120åˆ†é’Ÿ
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç«¯å£å†²çªæ£€æŸ¥

æ·»åŠ ç«¯å£å‰ï¼Œç¡®ä¿ç«¯å£æœªè¢«å…¶ä»–æœåŠ¡ä½¿ç”¨ï¼š
```bash
ss -tulnp | grep :8000
```

### 2. é˜²ç«å¢™è§„åˆ™

è„šæœ¬åªç›‘æ§æµé‡ï¼Œä¸ä¼šè‡ªåŠ¨å¼€æ”¾ç«¯å£ã€‚éœ€è¦æ‰‹åŠ¨é…ç½®é˜²ç«å¢™ï¼š
```bash
# nftables
nft add rule inet filter input tcp dport 8000 accept

# firewalld
firewall-cmd --add-port=8000/tcp --permanent
firewall-cmd --reload

# ufw
ufw allow 8000/tcp
```

### 3. ç½‘å¡è¯†åˆ«

è„šæœ¬ä¼šè‡ªåŠ¨æ£€æµ‹é»˜è®¤ç½‘å¡ï¼Œå¦‚æœè¯†åˆ«é”™è¯¯ï¼Œå¯èƒ½å¯¼è‡´é™é€Ÿä¸ç”Ÿæ•ˆã€‚æ£€æŸ¥ï¼š
```bash
ip route | grep default
# è¾“å‡º: default via 192.168.1.1 dev eth0
#                                    ^^^^^ é»˜è®¤ç½‘å¡
```

### 4. é…é¢é‡ç½®

é…é¢é‡ç½®ä»»åŠ¡ä¼šåœ¨æ¯æœˆæŒ‡å®šæ—¥æœŸçš„ **00:05** æ‰§è¡Œã€‚å¦‚æœæœåŠ¡å™¨åœ¨è¯¥æ—¶é—´å…³æœºï¼Œä¼šåœ¨ä¸‹æ¬¡å¯åŠ¨åæ‰§è¡Œï¼ˆsystemd Persistent=trueï¼‰ã€‚

### 5. çªå‘ä¿æŠ¤æ£€æµ‹å»¶è¿Ÿ

çªå‘ä¿æŠ¤æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼Œå› æ­¤ï¼š
- æœ€å¿« 1 åˆ†é’Ÿå†…è§¦å‘é™é€Ÿ
- é™é€Ÿæ—¶é•¿ç²¾åº¦ä¸ºåˆ†é’Ÿçº§

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜: æµé‡ç»Ÿè®¡ä¸º 0

**æ£€æŸ¥ nftables è§„åˆ™**:
```bash
sudo nft list table inet port_traffic
```

**æ£€æŸ¥è®¡æ•°å™¨**:
```bash
sudo nft list counters
```

å¦‚æœæ²¡æœ‰çœ‹åˆ°ç«¯å£ç›¸å…³çš„è®¡æ•°å™¨ï¼Œå°è¯•ï¼š
```bash
# åˆ é™¤ç«¯å£é‡æ–°æ·»åŠ 
ä¸»èœå• â†’ 2. åˆ é™¤ç«¯å£
ä¸»èœå• â†’ 1. æ·»åŠ ç«¯å£
```

### é—®é¢˜: é™é€Ÿä¸ç”Ÿæ•ˆ

**æ£€æŸ¥ TC è§„åˆ™**:
```bash
# æŸ¥çœ‹å‡ºç«™é™é€Ÿ
sudo tc -s class show dev eth0

# æŸ¥çœ‹å…¥ç«™é™é€Ÿ
sudo tc -s class show dev ifb0
```

**æ£€æŸ¥ IFB è®¾å¤‡**:
```bash
ip link show ifb0
# åº”è¯¥æ˜¾ç¤º: state UP
```

å¦‚æœ IFB æœªå¯åŠ¨ï¼š
```bash
sudo modprobe ifb numifbs=1
sudo ip link set ifb0 up
```

### é—®é¢˜: Telegram é€šçŸ¥å‘é€å¤±è´¥

**æµ‹è¯• Bot Token å’Œ Chat ID**:
```bash
BOT_TOKEN="ä½ çš„token"
CHAT_ID="ä½ çš„chat_id"

curl -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
  -d "chat_id=${CHAT_ID}" \
  -d "text=æµ‹è¯•æ¶ˆæ¯"
```

å¦‚æœè¿”å›é”™è¯¯ï¼Œæ£€æŸ¥ï¼š
- Bot Token æ˜¯å¦æ­£ç¡®
- Chat ID æ˜¯å¦æ­£ç¡®
- æ˜¯å¦å·²ä¸ Bot å‘é€è¿‡æ¶ˆæ¯

### é—®é¢˜: systemd timer æœªè§¦å‘

**æŸ¥çœ‹ timer çŠ¶æ€**:
```bash
systemctl list-timers | grep port-traffic
```

**æŸ¥çœ‹ timer è¯¦æƒ…**:
```bash
systemctl status port-traffic-alert.timer
```

**æ‰‹åŠ¨è§¦å‘æµ‹è¯•**:
```bash
sudo systemctl start port-traffic-alert.service
journalctl -u port-traffic-alert.service -n 50
```

---

## ğŸ“š è¿›é˜¶ä½¿ç”¨

### ç›´æ¥æ“ä½œæ•°æ®åº“

```bash
# æŸ¥çœ‹æ‰€æœ‰ç«¯å£
sqlite3 /etc/port-traffic-monitor/config.db "SELECT * FROM ports;"

# æŸ¥çœ‹é…é¢è®¾ç½®
sqlite3 /etc/port-traffic-monitor/config.db "SELECT * FROM quotas;"

# æŸ¥çœ‹æµé‡å¿«ç…§
sqlite3 /etc/port-traffic-monitor/config.db \
  "SELECT * FROM traffic_snapshots WHERE port='8000' ORDER BY timestamp DESC LIMIT 10;"
```

### å¯¼å‡ºé…ç½®

```bash
# å¯¼å‡ºæ•´ä¸ªæ•°æ®åº“
sqlite3 /etc/port-traffic-monitor/config.db .dump > backup.sql

# æ¢å¤
sqlite3 /etc/port-traffic-monitor/config.db < backup.sql
```

### è‡ªå®šä¹‰ Telegram æ¶ˆæ¯

ç¼–è¾‘è„šæœ¬çš„ `telegram_send_*` å‡½æ•°æ¥è‡ªå®šä¹‰æ¶ˆæ¯æ ¼å¼ã€‚

---

## âœ… æ£€æŸ¥æ¸…å•

å®‰è£…å®Œæˆåï¼Œç¡®è®¤ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] è„šæœ¬å¯åŠ¨æ— é”™è¯¯
- [ ] æ·»åŠ æµ‹è¯•ç«¯å£æˆåŠŸ
- [ ] æµé‡ç»Ÿè®¡æ­£å¸¸æ˜¾ç¤º
- [ ] å¸¦å®½é™é€Ÿç”Ÿæ•ˆï¼ˆä½¿ç”¨ `iperf3` æµ‹è¯•ï¼‰
- [ ] é…é¢è®¾ç½®æˆåŠŸ
- [ ] systemd timer å·²å¯åŠ¨
- [ ] Telegram é€šçŸ¥æµ‹è¯•æˆåŠŸ

---

**éœ€è¦å¸®åŠ©ï¼Ÿ** æŸ¥çœ‹å®Œæ•´æ–‡æ¡£ï¼š`PORT-MONITOR-V2-README.md`

**é‡åˆ°é—®é¢˜ï¼Ÿ** æäº¤ Issue å¹¶é™„ä¸Šï¼š
- ç³»ç»Ÿä¿¡æ¯: `uname -a`
- è„šæœ¬ç‰ˆæœ¬: `ptm --version`
- é”™è¯¯æ—¥å¿—: `journalctl -u port-traffic-*.service`
