# Snell 多实例管理脚本 (snell.sh)

**版本**: v5.2 | **快捷命令**: `snell` | **安装路径**: `/usr/local/bin/snell`

---

## 1. 概述

`snell.sh` 是一个专为 **Snell Server** 设计的高级管理脚本。它摒弃了传统脚本“一个端口一个服务文件”的臃肿设计，采用了 **Systemd 模板化服务** (`snell@.service`)，能够轻松管理单机上的多个 Snell 实例。

### 1.1 核心特性

*   **多实例支持:** 在同一台 VPS 上运行多个独立的 Snell 服务，每个实例拥有独立的端口、密码和配置文件。
*   **Systemd 模板化:** 所有实例共用一个 `snell@.service` 模板，管理极其方便。
    *   启动端口 10000: `systemctl start snell@10000`
    *   查看端口 20000 日志: `journalctl -u snell@20000`
*   **自动更新:** 尝试从 Surge 官方知识库抓取最新版本号，自动下载并平滑升级。
*   **权限安全:**
    *   创建独立用户 `snell` 运行服务。
    *   使用 `AmbientCapabilities=CAP_NET_BIND_SERVICE`，允许非 root 用户绑定 80/443 等低端口。

---

## 2. 安装与使用

### 2.1 一键安装

```bash
bash <(curl -fsSL https://raw.githubusercontent.com/white-u/vps_script/main/snell.sh)
```

### 2.2 常用命令

| 命令 | 说明 |
|------|------|
| `snell` | 进入交互式管理菜单 (主入口) |
| `snell add` | 快速添加一个新实例 |
| `snell update` | 更新管理脚本自身 |
| `snell install` | 强制重新安装/更新 Snell 核心 |

### 2.3 交互菜单

运行 `snell` 后可以看到如下界面：

```text
=========================================================================================
   Snell 多实例管理脚本 (v5.2)
=========================================================================================
 核心状态: v4.1.1    架构: x86_64
-----------------------------------------------------------------------------------------
 序号   端口         状态  IPv6      混淆      PSK
 ─────────────────────────────────────────────────────────────────────────────────────
 [1]    10086        运行中  true      off       aBcD1234...
 [2]    20000        已停止  true      http      xYz98765...
=========================================================================================
 1. 安装 / 更新 Snell 核心
 2. 添加实例 (新端口)
 3. 删除实例
 4. 查看客户端配置 (Surge/Stash)
 5. 更新管理脚本
 6. 卸载全部
 0. 退出
=========================================================================================
```

---

## 3. 配置文件

### 3.1 路径说明

*   **配置文件目录:** `/etc/snell/`
    *   每个实例对应一个文件，命名规则为 `<端口号>.conf` (例如: `/etc/snell/10086.conf`)。
*   **Systemd 服务文件:** `/etc/systemd/system/snell@.service`
*   **二进制文件:** `/usr/local/bin/snell-server`

### 3.2 配置文件示例 (10086.conf)

```ini
[snell-server]
listen = ::0:10086
psk = <自动生成的随机密钥>
ipv6 = true
tfo = true
obfs = off
dns = 1.1.1.1, 8.8.8.8, 2001:4860:4860::8888
```

### 3.3 客户端配置格式

脚本生成的分享链接/配置段可以直接复制到 Surge、Stash、Shadowrocket 等客户端使用：

```text
snell-node = snell, 1.2.3.4, 10086, psk=YourPassword, version=4, tfo=true, reuse=true
```

---

## 4. 常见问题

**Q: 如何手动重启某个实例？**
```bash
systemctl restart snell@端口号
# 例如重启 10086 端口
systemctl restart snell@10086
```

**Q: 如何查看特定实例的日志？**
```bash
journalctl -u snell@端口号 -n 20
# 例如查看 10086 端口的最近 20 行日志
journalctl -u snell@10086 -n 20
```

**Q: 如何修改端口密码？**
1.  编辑配置文件: `nano /etc/snell/端口号.conf`
2.  修改 `psk = ...` 这一行。
3.  重启服务: `systemctl restart snell@端口号`

**Q: 支持 HTTP 混淆吗？**
A: 支持。虽然脚本默认关闭混淆 (`obfs = off`) 以获得最佳性能，但你可以手动编辑配置文件开启 `obfs = http`。

---

## 5. 卸载

在菜单中选择 `6. 卸载全部`。
卸载会自动清理：
*   停止并禁用所有 Snell 服务实例。
*   删除 Systemd 服务文件。
*   删除配置文件目录 `/etc/snell`。
*   删除 `snell` 用户。
*   删除脚本自身。
