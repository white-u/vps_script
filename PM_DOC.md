# Linux 端口流量管理脚本 (Port Monitor & Shaper)

**版本**: v4.5.1 Stable | **快捷命令**: `pm` | **安装路径**: `/usr/local/bin/pm`

---

## 1. 概述

pm.sh 是一个基于 **Nftables + TC** 的端口级流量管理工具，适用于多用户 VPS 场景。它不仅能统计流量，还能进行配额管理、自动封禁、出站限速以及防止滥用的动态 QoS (DynQoS)。

**v4.5 新特性:**
*   **云端推送 (Cloudflare D1):** 支持将端口流量数据每分钟推送到 Cloudflare Worker，实现多节点集中监控。
*   **并发安全升级:** 引入了 `flock` 文件锁和 `USER_EDIT_LOCK` 机制，彻底解决了 Cron 后台任务与用户前台编辑时的冲突问题。
*   **规则自愈:** 每次 Cron 运行时自动检查 Nftables 表状态，防止规则意外丢失。

### 1.1 核心功能

*   **流量统计:** 精确统计每个端口的入站/出站流量 (Bytes)。
*   **配额管理:** 设定月流量配额 (GB)，支持双向计费或仅出站计费。
*   **自动封禁:** 流量超额后自动阻断端口 (Drop)，每月自动重置。
*   **基础限速:** 为端口设定固定的出站带宽限制 (Mbps)。
*   **DynQoS (防滥用):** 检测到持续大流量占用（突发）时，自动触发惩罚性限速，一段时间后恢复。
*   **通知系统:**
    *   **Telegram:** 流量预警、封禁通知、限速通知、定时报告。
    *   **Webhook (Cloudflare):** 支持 HMAC 签名的数据推送。

---

## 2. 安装与使用

### 2.1 一键安装

```bash
bash <(curl -fsSL https://raw.githubusercontent.com/white-u/vps_script/main/pm.sh)
```

### 2.2 常用命令

| 命令 | 说明 |
|------|------|
| `pm` | 进入交互式管理菜单 (主入口) |
| `pm update` | 检查并更新到最新版本 |
| `pm --monitor` | **请勿手动运行** (这是 Cron 后台任务专用的参数) |

### 2.3 交互菜单

运行 `pm` 后可以看到如下界面：

```text
=========================================================================================
   Linux 端口流量管理 (v4.5.1) - 后台每分钟刷新
=========================================================================================
 ID   端口         模式       已用流量 / 总配额             出站限速        备注
-----------------------------------------------------------------------------------------
 1    10086        [双向]     4.2 GB / 10 GB [R1]          100 Mbps        Snell
 2    20000        [仅出站]   [已阻断] / 5 GB              无限制          SS
 3    30000        [双向]     6.5 GB / 10 GB               5Mbps(惩罚中)   VMess
=========================================================================================
 ...
 4. 通知设置 (Telegram) ✅ 已开启
 5. 云端推送 (Cloudflare) ⚪ 未配置
 ...
```

*   **[R1]:** 表示每月 1 日自动重置流量。
*   **[已阻断]:** 流量用尽，端口已被防火墙封锁。
*   **(惩罚中):** 触发了 DynQoS，当前正处于惩罚限速状态。

---

## 3. 高级配置

### 3.1 动态限速 (DynQoS)

DynQoS 用于防止某个端口长时间占满带宽影响邻居。

*   **触发条件:** 当速率超过 `Trigger Mbps` 且持续 `Trigger Time` 分钟。
*   **惩罚措施:** 将该端口限速至 `Punish Mbps`，持续 `Punish Time` 分钟。
*   **恢复机制:** 惩罚时间结束后，自动恢复原有限速。

**配置示例:**
> 如果某端口连续 **5分钟** 速率超过 **100Mbps**，则将其限速至 **5Mbps**，持续 **60分钟**。

### 3.2 Telegram 通知

支持多种通知事件：
*   **配额预警:** 流量达到 50%, 80%, 100% 时发送通知。
*   **端口封禁:** 流量耗尽时通知。
*   **QoS 触发/恢复:** 触发限速和恢复限速时通知。
*   **定时报告:** 每 N 小时发送一次全端口流量汇总。

### 3.3 云端推送 (Cloudflare D1)

v4.4+ 新增功能，用于将多台 VPS 的流量数据汇总到一个 Dashboard。

*   **原理:** 每分钟 Cron 任务执行时，将 `config.json` 中的部分数据（脱敏后）通过 HTTP PUT 推送到指定的 Cloudflare Worker。
*   **安全性:** 使用 `HMAC-SHA256` 对数据进行签名，Worker 端验证签名防止伪造。
*   **配置参数:**
    *   `Worker URL`: 你的 Cloudflare Worker 地址。
    *   `Secret`: 通信密钥 (Shared Secret)。
    *   `Node Key`: 节点唯一标识 (如 `hk-01`)。

---

## 4. 技术细节

### 4.1 流量统计原理

*   **Nftables:** 使用 `nft` 的 named counter 功能，在内核态统计每个端口的流量包。
*   **原子性:** 每次读取内核计数器后，计算增量 (Delta)，累加到配置文件中。即使重启服务器，只要配置文件还在，累计流量就不会丢失。

### 4.2 限速原理 (TC)

*   **HTB 队列:** 使用 Linux TC 的 HTB (Hierarchical Token Bucket) 队列进行流量控制。
*   **Nftables Mark:** 使用 `nft` 对特定端口的出站流量打上 Mark (fwmark)。
*   **TC Filter:** `tc filter` 根据 Mark 将流量导向对应的 Class ID 进行限速。

### 4.3 并发控制 (Locking)

为了防止 Cron 后台任务与用户在前台编辑配置时发生冲突，pm.sh 实现了严格的锁机制：

1.  **菜单锁 (`USER_EDIT_LOCK`):** 当用户打开 `pm` 菜单时，创建此锁文件。Cron 任务检测到锁文件后，会直接跳过本次执行 (`exit 0`)，**避让**用户操作。
2.  **Cron 单例锁 (`CRON_LOCK_FILE`):** 使用 `flock` 确保同一时间只有一个 Cron 任务在运行，防止堆积。
3.  **写入锁 (`LOCK_FILE`):** 所有对 `config.json` 的写入操作都由 `flock` 保护，确保原子性，防止文件损坏。

---

## 5. 故障排查

**Q: 流量统计不更新？**
*   检查 Cron 服务是否运行: `systemctl status cron`
*   检查 Nftables 规则: `nft list table inet port_monitor`
*   检查是否处于“编辑模式” (菜单未退出)。

**Q: 限速不生效？**
*   检查是否安装了 `tc`: `tc -V`
*   某些精简版系统 (Alpine) 可能需要安装 `iproute2` 并加载内核模块 `sch_htb`。

**Q: Telegram 发不出消息？**
*   检查 Bot Token 和 Chat ID。
*   国内服务器请配置 API 反代地址。

---

## 6. 卸载

在菜单中选择 `7. 卸载脚本`，或运行 `pm uninstall`。
卸载会自动清理：
*   Cron 任务
*   Nftables 规则
*   TC 队列
*   配置文件和日志
*   脚本自身
