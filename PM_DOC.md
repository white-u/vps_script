# Linux 端口流量管理脚本 (Port Monitor & Shaper)

**版本**: v5.3.0 | **快捷命令**: `pm` | **安装路径**: `/usr/local/bin/pm`

---

## 1. 概述

pm.sh 是一个基于 **Nftables + TC** 的端口级流量管理工具，适用于多用户 VPS 场景。它不仅能统计流量，还能进行配额管理、自动封禁、出站限速以及防止滥用的动态 QoS (DynQoS)。

**v5.3 新特性:**
*   **配置自动迁移 (Auto-Migration):** 脚本现在具备自我维护能力。升级时会自动检测配置文件版本，并平滑迁移旧数据结构，无需人工干预。
*   **分组流量聚合:** 支持多端口共享配额。
*   **并发安全:** 严格的文件锁机制，防止 Cron 与人工操作冲突。

### 1.1 核心功能

*   **流量统计:** 精确统计每个端口的入站/出站流量 (Bytes)。
*   **分组管理:** 多端口流量合并计算，同组端口共享配额。
*   **配额管理:** 设定月流量配额 (GB)，超额自动封禁。
*   **DynQoS (防滥用):** 动态检测突发大流量，自动触发惩罚性限速。
*   **通知系统:** Telegram Bot + Cloudflare Worker 推送。

---

## 2. 安装与使用

### 2.1 一键安装

```bash
bash <(curl -fsSL https://raw.githubusercontent.com/white-u/vps_script/main/pm.sh)
```

### 2.2 常用命令

| 命令 | 说明 |
|------|------|
| `pm` | 进入交互式管理菜单 (主入口) |
| `pm update` | 检查并更新到最新版本 |
| `pm uninstall` | 卸载脚本及清除所有规则 |

### 2.3 交互菜单

运行 `pm` 后：

```text
=========================================================================================
   Linux 端口流量管理 (v5.3.0) - 后台每分钟刷新
=========================================================================================
 ID   端口         模式             已用流量 / 总配额             出站限速
-----------------------------------------------------------------------------------------
 1    10001        [双向] [G:vip1]  4.2 GB / 100 GB [R1]         100 Mbps
 2    10002        [双向] [G:vip1]  4.2 GB / 100 GB [R1]         100 Mbps
 3    20000        [仅出站]         [已阻断] / 5 GB              无限制
=========================================================================================
```

---

## 3. 分组流量聚合 (Group Traffic)

### 3.1 功能简介

允许将多个端口（如 `10001` 和 `10002`）绑定到同一个组（如 `vip1`）。
*   **流量共享:** 组内所有端口的流量合并计算。
*   **统一封禁:** 一旦总流量超过配额，整组端口同时封禁。
*   **自动同步:** 修改组内任意一个端口的配额或重置日，会自动同步给全组，防止逻辑冲突。

### 3.2 配置方法

1.  在主菜单选择 `2. 配置 端口`。
2.  选择目标端口。
3.  选择 `8. 设置/修改 分组 ID`。
    *   **选择现有组:** 脚本会列出已存在的组名，直接输入序号即可加入。
    *   **新建组:** 输入新的组名（支持字母、数字、下划线）。
    *   **退出组:** 留空回车即可清除分组。

---

## 4. 技术细节

### 4.1 数据迁移系统 (Migration)

从 v5.3.0 开始，`config.json` 引入了版本控制机制。
每次运行脚本时，`migrate_config` 函数会自动检查配置文件的版本：
*   **字段补全:** 自动为旧配置补充缺失的字段（如 `group_id`, `config_version`）。
*   **结构升级:** 如果未来数据结构发生重大变更，脚本会自动将旧数据转换为新格式，确保**无痛升级**。

### 4.2 流量统计原理 (Nftables)

使用 `nft` 的 named counter 功能，在内核态统计流量。每次读取后计算增量 (Delta) 并累加到配置文件中，重启不丢失。

### 4.3 动态限速原理 (TC)

*   **HTB 队列:** 使用 Linux TC 的 HTB 队列进行流量控制。
*   **Nftables Mark:** 使用 `nft` 对特定端口的出站流量打上 Mark。
*   **TC Filter:** 根据 Mark 将流量导向对应的 Class ID。

---

## 5. 故障排查

**Q: 升级后配置文件会不会丢？**
A: 不会。新的迁移系统会保护你的数据。即使脚本结构大改，它也会尝试兼容旧数据。

**Q: 为什么我修改配额时没有提示我是否同步？**
A: 为了保证数据一致性，v5.2+ 版本采取了**强制同步**策略。只要端口在组里，修改配额会自动覆盖全组，不再反复询问。

---

## 6. 卸载

在菜单中选择 `7. 卸载脚本`，或运行 `pm uninstall`。
卸载会自动清理 Cron 任务、Nftables 规则、TC 队列以及所有配置文件。
